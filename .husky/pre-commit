#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Running pre-commit hooks..."

# Check for merge conflicts markers
echo "🔍 Checking for merge conflict markers..."
git diff --cached --name-only | xargs grep -l "^<<<<<<< \|^======= \|^>>>>>>> " 2>/dev/null && {
  echo "❌ Merge conflict markers found! Please resolve conflicts before committing."
  exit 1
}

# Determine which apps have changes
WEBCLIENT_CHANGED=$(git diff --cached --name-only | grep -q "^apps/webclient/" && echo "true" || echo "false")
COMPASS_ADMIN_CHANGED=$(git diff --cached --name-only | grep -q "^apps/compass-admin/" && echo "true" || echo "false")

# Run quality checks and auto-fix for changed apps
echo "🔧 Running quality checks (type check, lint, format)..."

if [ "$WEBCLIENT_CHANGED" = "true" ] || [ "$COMPASS_ADMIN_CHANGED" = "true" ]; then
  # Run overall quality fix (formats and lints all projects)
  npm run quality:fix || {
    echo "❌ Quality checks failed!"
    exit 1
  }
  
  # Add any auto-fixed files back to staging
  git add .
else
  echo "ℹ️  No app changes detected, skipping quality checks"
fi

# Run tests for changed apps
echo "🧪 Running tests..."
if [ "$WEBCLIENT_CHANGED" = "true" ]; then
  echo "📱 Testing webclient..."
  npm run test:webclient || {
    echo "❌ Webclient tests failed!"
    exit 1
  }
fi

if [ "$COMPASS_ADMIN_CHANGED" = "true" ]; then
  echo "🏢 Testing compass-admin..."
  npm run test:compass-admin || {
    echo "❌ Compass-admin tests failed!"
    exit 1
  }
fi

if [ "$WEBCLIENT_CHANGED" = "false" ] && [ "$COMPASS_ADMIN_CHANGED" = "false" ]; then
  echo "ℹ️  No app changes detected, skipping tests"
fi

echo "✅ Pre-commit hooks passed! Ready to commit."