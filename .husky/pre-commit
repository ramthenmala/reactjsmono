#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit hooks..."

# Check for merge conflicts markers
echo "ğŸ” Checking for merge conflict markers..."
git diff --cached --name-only | xargs grep -l "^<<<<<<< \|^======= \|^>>>>>>> " 2>/dev/null && {
  echo "âŒ Merge conflict markers found! Please resolve conflicts before committing."
  exit 1
}

# Determine which apps have changes
WEBCLIENT_CHANGED=$(git diff --cached --name-only | grep -q "^apps/webclient/" && echo "true" || echo "false")
COMPASS_ADMIN_CHANGED=$(git diff --cached --name-only | grep -q "^apps/compass-admin/" && echo "true" || echo "false")

# Run quality checks and auto-fix for changed apps
echo "ğŸ”§ Running quality checks (type check, lint, format)..."

if [ "$WEBCLIENT_CHANGED" = "true" ] || [ "$COMPASS_ADMIN_CHANGED" = "true" ]; then
  # Run overall quality fix (formats and lints all projects)
  npm run quality:fix || {
    echo "âŒ Quality checks failed!"
    exit 1
  }
  
  # Add any auto-fixed files back to staging
  git add .
else
  echo "â„¹ï¸  No app changes detected, skipping quality checks"
fi

# Run tests for changed apps
echo "ğŸ§ª Running tests..."
if [ "$WEBCLIENT_CHANGED" = "true" ]; then
  echo "ğŸ“± Testing webclient..."
  npm run test:webclient || {
    echo "âŒ Webclient tests failed!"
    exit 1
  }
fi

if [ "$COMPASS_ADMIN_CHANGED" = "true" ]; then
  echo "ğŸ¢ Testing compass-admin..."
  npm run test:compass-admin || {
    echo "âŒ Compass-admin tests failed!"
    exit 1
  }
fi

if [ "$WEBCLIENT_CHANGED" = "false" ] && [ "$COMPASS_ADMIN_CHANGED" = "false" ]; then
  echo "â„¹ï¸  No app changes detected, skipping tests"
fi

echo "âœ… Pre-commit hooks passed! Ready to commit."